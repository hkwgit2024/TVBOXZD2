# .github/workflows/speedtest.yml
name: Clash Speed Test and Sort

on:
  workflow_dispatch: # Allows manual trigger
  schedule:
    - cron: '0 */6 * * *' # Runs every 6 hours (adjust as needed)

jobs:
  speed-test-and-sort:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Make Speedtest Tool Executable
      run: chmod +x ./speedtest-clash

    - name: Run Speed Test and Capture Output
      # Run speedtest-clash and redirect its full output to a temporary file
      # Also print output to the log (using tee)
      run: |
        echo "Starting speedtest-clash and capturing output..."
        ./speedtest-clash \
          -c ./clash_config.yaml \
          -output /dev/null \
          -sort b \
          -size 52428800 \
          -timeout 10s | tee speedtest_output.log
        
        EXIT_CODE=$?
        echo "speedtest-clash exited with code: ${EXIT_CODE}"
        echo "--- End of speedtest-clash run ---"

    - name: Extract Sorted Proxies and Generate clash.yaml
      id: generate_clash_yaml # ID for this step
      run: |
        echo "Extracting sorted proxies from log and generating clash.yaml..."
        
        # --- Install jq tool ---
        sudo apt-get update && sudo apt-get install -y jq
        echo "jq installed successfully."
        # --- End jq installation ---

        # Use grep to find the line containing "json: "
        # Then use sed to remove the "json: " prefix
        SORTED_PROXIES_JSON=$(grep -oP 'json: \[\{.*?\}\]' speedtest_output.log | sed 's/^json: //')
        
        if [ -z "$SORTED_PROXIES_JSON" ]; then
          echo "Error: Could not extract sorted proxies JSON from the log. Please check 'speedtest_output.log'."
          exit 1
        fi

        # Extract all content from clash_config.yaml before the 'proxies:' line
        ORIGINAL_CONFIG_HEADER=$(awk '/^proxies:/ {exit} {print}' clash_config.yaml)
        
        # Format the proxy JSON for Clash YAML and apply indentation
        # Use jq for pretty printing, then sed to add 4 spaces indentation
        FORMATTED_PROXIES=$(echo "$SORTED_PROXIES_JSON" | jq '.' | sed 's/^/    /')

        # Write the header and the sorted proxies to clash.yaml
        echo "$ORIGINAL_CONFIG_HEADER" > clash.yaml
        echo "proxies:" >> clash.yaml
        echo "$FORMATTED_PROXIES" >> clash.yaml

        echo "--- Generated clash.yaml ---"
        cat clash.yaml # Print the generated file content to the log
        echo "--------------------------"

    - name: Verify Generated File and Directory
      # Check if clash.yaml exists, and list directory contents
      id: check_file_after_generation # ID for this step
      run: |
        echo "Verifying 'clash.yaml' file existence after generation..."
        ls -la
        
        if [ -f "clash.yaml" ]; then
          echo "'clash.yaml' found! Content should be correct."
          echo "File size: $(du -h clash.yaml | awk '{print $1}')"
          echo "First 20 lines of 'clash.yaml':"
          head -n 20 clash.yaml
        else
          echo "Critical Error: 'clash.yaml' was NOT generated. Commit step will fail."
          exit 1 # Force job failure if file is not generated
        fi

    - name: Commit and Push Sorted Config
      uses: stefanzweifel/git-auto-commit-action@v5
      with:
        commit_message: "Update Clash config with sorted nodes by speed"
        files: clash.yaml
        branch: main
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      # Only attempt commit if previous steps succeeded and the file was verified
      if: success() && steps.check_file_after_generation.outcome == 'success'
