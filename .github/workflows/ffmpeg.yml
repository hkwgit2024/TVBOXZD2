name: 测试 IPTV 频道检查和分类

on:
  push:
    paths:
      - '.github/workflows/ffmpeg.yml'
      - 'check_and_categorize_channels.py'
      - 'config/**'
      - 'output/iptv.txt'
  workflow_dispatch:
  schedule:
    # 每天 00:00（北京时间）运行
    - cron: '0 0 * * *'

env:
  TZ: Asia/Shanghai

permissions:
  contents: write  # 允许推送更改到仓库

jobs:
  check-and-categorize:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.8'

      - name: Check input file
        run: |
          if [ ! -f output/iptv.txt ]; then
            echo "错误：未找到 output/iptv.txt"
            exit 1
          fi

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # 移除 difflib，因为它是标准库
          echo -e "PyYAML==6.0\nrequests==2.31.0\ntenacity==8.2.3\ncachetools==5.3.1\ntqdm==4.66.4\npsutil==5.9.5" > requirements.txt
          pip install -r requirements.txt
          sudo apt-get update
          sudo apt-get install -y ffmpeg

      - name: Run channel check and categorization script
        run: |
          python check_and_categorize_channels.py
        continue-on-error: false

      - name: Store logs as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: iptv-checker-logs
          path: logs/iptv_checker.log
          retention-days: 7
          if-no-files-found: warn

      - name: Commit and push changes
        if: success()
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add .
          if ! git diff --cached --quiet; then
            git commit -m "Update categorized IPTV lists and demo.txt"
            git push origin main --no-verify
          else
            echo "没有需要提交的更改，退出。"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Handle push failure
        if: failure()
        run: |
          echo "推送失败，可能是冲突或权限问题。请检查日志。"
          exit 1
