name: 订阅转换自动化

on:
  push:
    paths:
      - '.github/workflows/converter.yml'
  workflow_dispatch:
    inputs:
      subscription_url:
        description: '请输入你的订阅链接'
        required: true
        default: 'https://raw.githubusercontent.com/qjlxg/HA/refs/heads/main/all_unique_nodes.txt'

jobs:
  convert:
    runs-on: ubuntu-latest
    steps:
      - name: 🔔 检出仓库
        uses: actions/checkout@v4

      - name: 🔧 启动 Subconverter 服务
        run: |
          set -e
          # 启动 subconverter 的 Docker 容器
          docker run -d --rm --name subconverter -p 25500:25500 tindy2013/subconverter:latest

          # 检查服务是否启动成功，循环等待直到服务可用
          echo "等待 Subconverter 服务启动..."
          until $(curl --output /dev/null --silent --head --fail http://localhost:25500/version); do
            printf '.'
            sleep 5
          done
          echo "服务已启动!"

      - name: 🔄 转换订阅链接并保存
        id: convert
        env:
          SUB_URL: ${{ github.event.inputs.subscription_url }}
        run: |
          set -e
          echo "正在转换订阅链接..."
          
          # 使用 curl 调用 subconverter API 进行转换
          # url：指定你的原始节点列表文件
          # target：指定输出格式为 Clash
          curl -s --max-time 300 "http://localhost:25500/sub?target=clash&url=${{ env.SUB_URL }}" -o config.yaml

          # 检查文件是否生成
          if [ ! -s config.yaml ]; then
            echo "::error::无法生成 config.yaml 文件，请检查订阅链接是否有效或重试。"
            exit 1
          fi
          echo "✅ 订阅转换完成，配置文件已保存为 config.yaml"

      - name: 💾 保存结果到仓库
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "feat: 更新 Clash 配置文件"
          file_pattern: "config.yaml"
