name: è®¢é˜…è½¬æ¢è‡ªåŠ¨åŒ–

on:
  push:
    paths:
      - '.github/workflows/converter.yml'
  workflow_dispatch:
    inputs:
      subscription_url:
        description: 'è¯·è¾“å…¥ä½ çš„è®¢é˜…é“¾æ¥'
        required: true
        default: 'https://raw.githubusercontent.com/qjlxg/HA/refs/heads/main/all_unique_nodes.txt'

jobs:
  convert:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ”” æ£€å‡ºä»“åº“
        uses: actions/checkout@v4

      - name: ğŸ”§ å¯åŠ¨ Subconverter æœåŠ¡
        run: |
          set -e
          # å¯åŠ¨ subconverter çš„ Docker å®¹å™¨
          docker run -d --rm --name subconverter -p 25500:25500 tindy2013/subconverter:latest

          # æ£€æŸ¥æœåŠ¡æ˜¯å¦å¯åŠ¨æˆåŠŸï¼Œå¾ªç¯ç­‰å¾…ç›´åˆ°æœåŠ¡å¯ç”¨
          echo "ç­‰å¾… Subconverter æœåŠ¡å¯åŠ¨..."
          until $(curl --output /dev/null --silent --head --fail http://localhost:25500/version); do
            printf '.'
            sleep 5
          done
          echo "æœåŠ¡å·²å¯åŠ¨!"

      - name: ğŸ”„ è½¬æ¢è®¢é˜…é“¾æ¥å¹¶ä¿å­˜
        id: convert
        env:
          SUB_URL: ${{ github.event.inputs.subscription_url }}
        run: |
          set -e
          echo "æ­£åœ¨è½¬æ¢è®¢é˜…é“¾æ¥..."
          
          # ä½¿ç”¨ curl è°ƒç”¨ subconverter API è¿›è¡Œè½¬æ¢
          # urlï¼šæŒ‡å®šä½ çš„åŸå§‹èŠ‚ç‚¹åˆ—è¡¨æ–‡ä»¶
          # targetï¼šæŒ‡å®šè¾“å‡ºæ ¼å¼ä¸º Clash
          curl -s --max-time 300 "http://localhost:25500/sub?target=clash&url=${{ env.SUB_URL }}" -o config.yaml

          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦ç”Ÿæˆ
          if [ ! -s config.yaml ]; then
            echo "::error::æ— æ³•ç”Ÿæˆ config.yaml æ–‡ä»¶ï¼Œè¯·æ£€æŸ¥è®¢é˜…é“¾æ¥æ˜¯å¦æœ‰æ•ˆæˆ–é‡è¯•ã€‚"
            exit 1
          fi
          echo "âœ… è®¢é˜…è½¬æ¢å®Œæˆï¼Œé…ç½®æ–‡ä»¶å·²ä¿å­˜ä¸º config.yaml"

      - name: ğŸ’¾ ä¿å­˜ç»“æœåˆ°ä»“åº“
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "feat: æ›´æ–° Clash é…ç½®æ–‡ä»¶"
          file_pattern: "config.yaml"
