name: 更新和转换

on:
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * *'

jobs:
  update-and-convert-nodes:
    runs-on: ubuntu-latest

    steps:
    - name: 检出仓库代码
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: 拉取并合并远程最新更改
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
        git fetch origin
        git checkout main
        git pull --rebase origin main
        if [ $? -ne 0 ]; then
          echo "Rebase 失败，尝试合并"
          git rebase --abort || true
          git merge origin/main --no-edit
        fi

    - name: 设置 Python 环境
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'

    - name: 安装依赖库
      run: |
        pip install aiohttp beautifulsoup4 pyyaml fake-useragent playwright
        playwright install

    - name: 创建 data 目录
      run: mkdir -p data

    - name: 打印当前工作目录
      run: pwd

    - name: 运行代理转换脚本
      working-directory: ${{ github.workspace }}
      run: python proxy_converter.py --sources sources.list --nodes-output data/nodes.txt --stats-output data/node_counts.csv --max-concurrency 50 --timeout 20 --debug

    - name: 检查生成的文件
      run: |
        ls -la data/
        echo "=== nodes.txt 前10行 ==="
        head -n 10 data/nodes.txt || echo "nodes.txt 未找到或为空"
        echo "=== node_counts.csv 内容 ==="
        cat data/node_counts.csv || echo "node_counts.csv 未找到或为空"
        echo "=== proxy_converter.log 内容 ==="
        cat proxy_converter.log || echo "proxy_converter.log 未找到"
        echo "=== Git 差异 ==="
        git diff --name-only || echo "无文件更改"

    - name: 提交并推送更改
      uses: stefanzweifel/git-auto-commit-action@v5
      with:
        commit_message: "自动更新代理节点及生成 Clash 配置"
        file_pattern: |
          data/nodes.txt
          data/node_counts.csv
        commit_options: '--allow-empty'
        push_options: '--force'
