name: æ›´æ–°å’Œè½¬æ¢ä»£ç†èŠ‚ç‚¹

on:
  workflow_dispatch: # æ‰‹åŠ¨è§¦å‘
    inputs:
      max_concurrency:
        description: 'æœ€å¤§å¹¶å‘è¯·æ±‚æ•°'
        default: '50'
        required: false
      timeout:
        description: 'è¯·æ±‚è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰'
        default: '20'
        required: false
      validate_nodes:
        description: 'æ˜¯å¦éªŒè¯èŠ‚ç‚¹æœ‰æ•ˆæ€§'
        default: 'true'
        type: boolean
      protocol_split:
        description: 'æ˜¯å¦æŒ‰åè®®åˆ†å‰²è¾“å‡º'
        default: 'true'
        type: boolean
      output_formats:
        description: 'è¾“å‡ºæ ¼å¼ï¼ˆtxt,json,yamlï¼Œç”¨é€—å·åˆ†éš”ï¼‰'
        default: 'txt,json'
        required: false
  schedule:
    # æ¯å¤©å‡Œæ™¨2ç‚¹ï¼ˆUTCï¼‰ï¼Œæ—¥æœ¬æ—¶é—´ä¸Šåˆ11ç‚¹
    - cron: '0 2 * * *'
  push:
    branches:
      - main
    paths:
      - 'sources.list'
      - 'proxy_converter.py'
      - 'config.yaml'

# ç¯å¢ƒå˜é‡
env:
  PYTHON_VERSION: '3.11'
  SOURCES_FILE: 'sources.list'
  OUTPUT_DIR: 'data'
  OUTPUT_BASE: 'nodes'
  STATS_OUTPUT: 'data/node_counts.csv'
  CONFIG_FILE: 'config.yaml'
  CACHE_DIR: '.cache'
  MAX_CONCURRENCY: ${{ github.event.inputs.max_concurrency || '50' }}
  TIMEOUT: ${{ github.event.inputs.timeout || '20' }}
  VALIDATE_NODES: ${{ github.event.inputs.validate_nodes || 'true' }}
  PROTOCOL_SPLIT: ${{ github.event.inputs.protocol_split || 'true' }}
  OUTPUT_FORMATS: ${{ github.event.inputs.output_formats || 'txt,json' }}

jobs:
  update-and-convert-nodes:
    runs-on: ubuntu-latest
    timeout-minutes: 60 # ä½œä¸šè¶…æ—¶æ—¶é—´

    steps:
    # 1. æ£€å‡ºä»“åº“ä»£ç 
    - name: æ£€å‡ºä»“åº“ä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0 # è·å–å®Œæ•´å†å²
        ref: main

    # 2. æ‹‰å–è¿œç¨‹æœ€æ–°æ›´æ”¹
    - name: æ‹‰å–è¿œç¨‹æœ€æ–°æ›´æ”¹
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
        git pull --rebase --autostash origin main || {
          echo "æ‹‰å–è¿œç¨‹æ›´æ”¹å¤±è´¥ï¼Œé‡ç½®åˆ°è¿œç¨‹çŠ¶æ€"
          git fetch origin
          git reset --hard origin/main
        }

    # 3. ç¼“å­˜ Python ä¾èµ–
    - name: ç¼“å­˜ Python ä¾èµ–
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    # 4. ç¼“å­˜ Playwright æµè§ˆå™¨
    - name: ç¼“å­˜ Playwright æµè§ˆå™¨
      uses: actions/cache@v4
      with:
        path: ~/.cache/playwright
        key: ${{ runner.os }}-playwright-${{ hashFiles('proxy_converter.py') }}
        restore-keys: |
          ${{ runner.os }}-playwright-

    # 5. è®¾ç½® Python ç¯å¢ƒ
    - name: è®¾ç½® Python ç¯å¢ƒ
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    # 6. å®‰è£…ä¾èµ–åº“
    - name: å®‰è£…ä¾èµ–åº“
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then
          pip install -r requirements.txt
        else
          pip install aiohttp beautifulsoup4 pyyaml fake-useragent playwright aiofiles tqdm
        fi
        playwright install --with-deps chromium

    # 7. æ¸…ç†æ—§è¾“å‡ºæ–‡ä»¶
    - name: æ¸…ç†æ—§è¾“å‡ºæ–‡ä»¶
      run: |
        mkdir -p ${{ env.OUTPUT_DIR }}
        find ${{ env.OUTPUT_DIR }} -type f \( -name "${{ env.OUTPUT_BASE }}*.txt" -o -name "${{ env.OUTPUT_BASE }}*.json" -o -name "${{ env.OUTPUT_BASE }}*.yaml" -o -name "${{ env.STATS_OUTPUT }}" \) -delete
        echo "å·²æ¸…ç†æ—§çš„è¾“å‡ºæ–‡ä»¶"

    # 8. è¿è¡Œä»£ç†è½¬æ¢è„šæœ¬
    - name: è¿è¡Œä»£ç†è½¬æ¢è„šæœ¬
      id: run-script
      run: |
        python proxy_converter.py \
          --sources ${{ env.SOURCES_FILE }} \
          --output-dir ${{ env.OUTPUT_DIR }} \
          --output-base ${{ env.OUTPUT_BASE }} \
          --stats-output ${{ env.STATS_OUTPUT }} \
          --config-file ${{ env.CONFIG_FILE }} \
          --max-concurrency ${{ env.MAX_CONCURRENCY }} \
          --timeout ${{ env.TIMEOUT }} \
          --use-browser \
          --validate-nodes=${{ env.VALIDATE_NODES }} \
          --protocol-split=${{ env.PROTOCOL_SPLIT }} \
          --output-formats ${{ env.OUTPUT_FORMATS }} \
          --cache-dir ${{ env.CACHE_DIR }}
      continue-on-error: true

    # 9. æ£€æŸ¥è„šæœ¬æ‰§è¡Œç»“æœ
    - name: æ£€æŸ¥è„šæœ¬æ‰§è¡Œç»“æœ
      run: |
        if [ ${{ steps.run-script.outcome }} == "success" ]; then
          echo "ä»£ç†è½¬æ¢è„šæœ¬æ‰§è¡ŒæˆåŠŸ"
        else
          echo "ä»£ç†è½¬æ¢è„šæœ¬æ‰§è¡Œå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
          exit 1
        fi

    # 10. æäº¤å¹¶æ¨é€æ›´æ”¹
    - name: æäº¤å¹¶æ¨é€æ›´æ”¹
      uses: stefanzweifel/git-auto-commit-action@v5
      with:
        commit_message: "è‡ªåŠ¨æ›´æ–°ä»£ç†èŠ‚ç‚¹åŠç”ŸæˆèŠ‚ç‚¹ç»Ÿè®¡ (#${{ github.run_number }})"
        file_pattern: |
          ${{ env.OUTPUT_DIR }}/*.txt
          ${{ env.OUTPUT_DIR }}/*.json
          ${{ env.OUTPUT_DIR }}/*.yaml
          ${{ env.STATS_OUTPUT }}
        branch: main
        push_options: --force
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    # 11. ä¿å­˜æ—¥å¿—æ–‡ä»¶
    - name: ä¿å­˜æ—¥å¿—æ–‡ä»¶
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: proxy-converter-logs
        path: ${{ env.LOG_FILE }}
        retention-days: 7

    # 12. å‘é€é€šçŸ¥åˆ° Discord
    - name: å‘é€é€šçŸ¥åˆ° Discord
      if: always()
      uses: Ilshidur/action-discord@0.3.2
      env:
        DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
      with:
        args: |
          **ä»£ç†èŠ‚ç‚¹æ›´æ–° #${{ github.run_number }}**  
          çŠ¶æ€: ${{ job.status }}  
          ä»“åº“: ${{ github.repository }}  
          æäº¤: ${{ github.sha }}  
          æ—¥å¿—: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}  
          ${{ job.status == 'success' && 'ğŸ‰ æ›´æ–°å®Œæˆï¼' || 'âŒ æ›´æ–°å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—ï¼' }}

    # 13. å‘é€é€šçŸ¥åˆ° Telegramï¼ˆå¯é€‰ï¼‰
    - name: å‘é€é€šçŸ¥åˆ° Telegram
      if: always()
      uses: appleboy/telegram-action@master
      with:
        to: ${{ secrets.TELEGRAM_CHAT_ID }}
        token: ${{ secrets.TELEGRAM_TOKEN }}
        message: |
          ä»£ç†èŠ‚ç‚¹æ›´æ–° #${{ github.run_number }}
          çŠ¶æ€: ${{ job.status }}
          ä»“åº“: ${{ github.repository }}
          æäº¤: ${{ github.sha }}
          æ—¥å¿—: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          ${{ job.status == 'success' && 'ğŸ‰ æ›´æ–°å®Œæˆï¼' || 'âŒ æ›´æ–°å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—ï¼' }}
