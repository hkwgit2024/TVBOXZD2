name: 更新和转换

on:
  workflow_dispatch: # 允许手动触发
  schedule:
    # 每天凌晨2点（UTC时间）运行，转换为日本时间是上午11点
    - cron: '0 2 * * *'

jobs:
  update-and-convert-nodes:
    runs-on: ubuntu-latest

    steps:
    - name: 检出仓库代码
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: 拉取远程最新更改
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
        git pull --rebase --autostash origin main || true

    - name: 设置 Python 环境
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'

    - name: 安装依赖库
      run: |
        pip install aiohttp beautifulsoup4 pyyaml fake-useragent playwright
        playwright install

    - name: 运行代理转换脚本
      run: python proxy_converter.py --sources sources.list --output data/nodes.txt --stats-output data/node_counts.csv --max-concurrency 50 --timeout 20 --chunk-size-mb 95

   # - name: 检查生成的文件
   #   run: |
    #    ls -la data/
   #     cat data/nodes.txt || echo "data/nodes.txt 不存在或为空"
   #     cat data/node_counts.csv || echo "data/node_counts.csv 不存在或为空"
    #    find data/ -name "nodes_*.txt" -exec echo "找到分片文件: {}" \; -exec cat {} \;

    - name: 提交并推送更改
      uses: stefanzweifel/git-auto-commit-action@v5
      with:
        commit_message: "自动更新代理节点及生成 Clash 配置"
        file_pattern: |
          data/nodes.txt
          data/nodes_*.txt
          data/node_counts.csv
        branch: main
