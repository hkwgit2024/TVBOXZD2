name: Clash 速度测试与排序

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'

jobs:
  speed-test-and-sort:
    runs-on: ubuntu-latest
    steps:
      - name: 检出仓库
        uses: actions/checkout@v4

      - name: 安装 yq 工具（mikefarah/yq v4）
        run: |
          echo "安装 mikefarah/yq v4 工具..."
          sudo wget -qO /usr/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/bin/yq
          yq --version

      - name: 赋予 clash-speedtest 和脚本执行权限
        run: |
          if [ ! -f "./clash-speedtest" ]; then
            echo "错误: 未找到 'clash-speedtest' 文件，请确保已上传至仓库根目录"
            exit 1
          fi
          chmod +x ./clash-speedtest
          if [ ! -f "./scripts/merge_subscriptions.sh" ]; then
            echo "错误: 未找到 'scripts/merge_subscriptions.sh' 文件，请确保已上传"
            exit 1
          fi
          chmod +x ./scripts/merge_subscriptions.sh
          echo "已设置 'clash-speedtest' 和 'merge_subscriptions.sh' 为可执行文件"

      - name: 下载、修复并合并 Clash 订阅文件
        id: merge-subs
        run: |
          echo "运行合并订阅脚本..."
          bash ./scripts/merge_subscriptions.sh "${{ vars.NODE_LIST_URLS }}" || {
            echo "错误: 合并订阅脚本执行失败"
            exit 1
          }
          if [ ! -f "clash_subscriptions.yaml" ] || [ ! -s "clash_subscriptions.yaml" ]; then
            echo "错误: 未生成有效的 'clash_subscriptions.yaml' 文件"
            exit 1
          fi
          echo "clash_subscriptions.yaml 已生成，大小: $(du -h clash_subscriptions.yaml | awk '{print $1}')"
          head -n 20 clash_subscriptions.yaml
          echo "fixed_subs_path=clash_subscriptions.yaml" >> $GITHUB_OUTPUT

      - name: 执行速度测试
        run: |
          echo "运行速度测试..."
          ./clash-speedtest -c "${{ steps.merge-subs.outputs.fixed_subs_path }}" \
            -output clash.yaml \
            -download-size 5242880 \
            -upload-size 5242880 \
            -timeout 5s \
            -concurrent 50 || {
              echo "错误: 速度测试失败"
              exit 1
            }

      - name: 验证生成的文件
        run: |
          if [ ! -s clash.yaml ]; then
            echo "错误: 未生成有效的 clash.yaml 文件"
            exit 1
          fi
          echo "clash.yaml 已生成，大小: $(du -h clash.yaml | awk '{print $1}')"
          head -n 20 clash.yaml

      - name: 提交排序后的配置文件
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "更新 Clash 配置：节点已按速度排序"
          file_pattern: clash.yaml
          branch: main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
