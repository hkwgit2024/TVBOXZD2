name: config

on:
  push:
   paths:
   - '.github/workflows/config.yml'
  workflow_dispatch:
    inputs:
      subscription_url:
        description: 'è¯·è¾“å…¥ä½ çš„è®¢é˜…é“¾æ¥'
        required: true
        default: 'https://github.com/qjlxg/HA/raw/refs/heads/main/config.yaml'

jobs:
  convert_and_test:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ”” æ£€å‡ºä»“åº“
        uses: actions/checkout@v4

      - name: ğŸ”§ å¯åŠ¨ Subconverter æœåŠ¡
        run: |
          # å¯åŠ¨ subconverter çš„ Docker å®¹å™¨
          docker run -d --rm --name subconverter -p 25500:25500 tindy2013/subconverter:latest

          # æ£€æŸ¥æœåŠ¡æ˜¯å¦å¯åŠ¨æˆåŠŸ
          sleep 10
          curl http://localhost:25500/version

      - name: ğŸ”„ è½¬æ¢è®¢é˜…é“¾æ¥
        id: convert
        env:
          SUB_URL: ${{ github.event.inputs.subscription_url }}
        run: |
          # ä½¿ç”¨ curl è°ƒç”¨ subconverter API è¿›è¡Œè½¬æ¢
          # target=clashï¼šæŒ‡å®šè¾“å‡ºæ ¼å¼ä¸º Clash
          # urlï¼šæŒ‡å®šè®¢é˜…é“¾æ¥
          # &filename=config.yamlï¼šæŒ‡å®šè¾“å‡ºæ–‡ä»¶åï¼Œå¹¶ä¿å­˜
          curl -s --max-time 300 "http://localhost:25500/sub?target=clash&url=${{ env.SUB_URL }}" -o config.yaml

          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦ç”Ÿæˆ
          if [ ! -f config.yaml ]; then
            echo "::error::æ— æ³•ç”Ÿæˆ config.yaml æ–‡ä»¶ï¼Œè¯·æ£€æŸ¥è®¢é˜…é“¾æ¥æ˜¯å¦æœ‰æ•ˆã€‚"
            exit 1
          fi
          echo "âœ… è®¢é˜…è½¬æ¢å®Œæˆï¼Œé…ç½®æ–‡ä»¶å·²ä¿å­˜ä¸º config.yaml"

      - name: ğŸš€ ä¸‹è½½ Clash å†…æ ¸è¿›è¡Œæµ‹é€Ÿ
        run: |
          # ä¸‹è½½ clash-speedtestï¼Œè¿™é‡Œä½¿ç”¨ mihomo
          CLASH_VER=v1.18.2
          wget https://github.com/MetaCubeX/mihomo/releases/download/${CLASH_VER}/mihomo-linux-amd64-${CLASH_VER}.gz
          gunzip mihomo-linux-amd64-${CLASH_VER}.gz
          mv mihomo-linux-amd64-${CLASH_VER} clash-test
          chmod +x clash-test

      - name: ğŸ’¨ è¿è¡ŒèŠ‚ç‚¹æµ‹é€Ÿ
        run: |
          # è¿è¡Œ clash-testï¼ŒæŒ‡å®šé…ç½®æ–‡ä»¶è¿›è¡Œæµ‹é€Ÿ
          ./clash-test -t -c config.yaml
